# 计算机系统漫游:rocket:

**计算机系统**是由硬件和系统软件组成的，它们共同工作来运行应用程序。系统的具体实现方式在不断变化，但内在概念没有改变——所有的计算机系统组件与功能都是相似的。

本次漫游，我们将通过跟踪 `hello` 程序的生命周期来进行——被程序员创建、到在系统上运行、到输出信息，最后终止。

```c
#include <stdio.h>

int main() {
    printf("Hello world!");
    return 0;
}
```



### 1.1 信息就是位+上下文

`hello` 程序的生命周期从一个源程序开始，源程序实际上是一个由0和1组成的位（比特）序列，每 8 个比特被称为一个**字节**。大部分现代计算机系统都使用 **ASCII** 标准来表示文本字符，这种方式让我们得以用一个唯一的单字节大小的整数值来表示每个字符，`hello.c`也不例外。这种表示方法说明了**一个基本思想——系统中所有信息都是由一串比特表示的，区分不同数据对象的唯一方法就是通过这些数据对象的上下文来判断。**



### 1.2 程序被其他程序翻译成不同的格式

`hello` 程序的生命周期始于一个高级C语言程序，但为了在系统上运行我们需要把这些人类易懂的 C 语句用其他程序翻译为一系列低级机器语言指令。这些指令按照**可执行目标程序**的格式打好包，并以二进制磁盘文件的形式存放。

翻译过程分为四个阶段，执行这四个阶段的程序（**预处理器**、**编译器**、**汇编器**和**链接器**）一起构成了**编译系统**。

![](/notes/img/1.1.png)

- **预处理阶段**  **预处理器**根据已字符 # 开头的命令修改原始的 C 程序（将读取到的头文件信息直接插入程序文本中，得到以 `.i` 结尾的另一个 C 程序）

- **编译阶段**  **编译器**将 `hello.i` 翻译成文本文件 `hello.s`，它包含一个**汇编语言程序**。该程序包含函数 `main` 的定义：

  ```
  main:
  	subq	$8, %rsp
  	movl	$.LC0, %edi
  	call	puts
  	movl	$0, %eax
  	addq	$8, %rsp
  	ret
  ```

  *汇编语言非常有用！它为不同高级语言和不同编译器提供了通用的输出语句*

- **汇编阶段**  **汇编器**将 `hello.s` 翻译成机器语言指令，把这些指令打包成一种叫做**可重定位目标程序**的格式，并将结果保存在一个二进制形式的目标文件 `hello.o` 中。

- **链接阶段**  `hello` 程序调用了标准 C 库中的 `printf` 函数，它存在于一个名为 `printf.o` 的单独的预编译好了的目标文件中，而这个文件由**链接器**合并到 `hello.o`程序中，最后得到 `hello` 文件。`hello` 文件是一个**可执行目标文件**，可以被加载到内存中由系统执行。



### 1.3 了解编译系统如何工作是大有益处的

对于 `hello.c` 这样简单的程序，我们可以依靠编译系统生成正确有效的机器代码。但是程序员仍然有必要进一步了解编译系统是如何工作的。

- **优化程序性能**  现代编译器已经非常成熟，但为了做出更好的编码选择，我们仍然需要了解一些机器代码以及编译器将 C 语句转化成机器代码的方式—— `switch` 还是 `if-else`？`while` 还是 `for`？指针引用还是数组索引？本地变量还是引用传参......

- **理解链接时出现的错误**  一些最麻烦的程序错误常常与链接器操作有关。无法解析引用是什么意思？静态变量和全局变量有何区别？全局变量重名会发生什么......

- **避免安全漏洞**

  

### 1.4 处理器读并解释储存在内存中的指令

此时我们已经成功获取了可执行目标文件 `hello`！接下来让我们看看运行它的时候发生了什么。

#### 1.4.1 系统的硬件组成



- **总线**  贯穿整个系统的是一组电子管道，称作**总线**，它携带信息字节并负责在各个部件间传递。通常总线被设计成传送定长的字节块，也就是**字**。字中的字节数（即**字长**）是一个基本的系统参数，一般为 4 或 8 个字节（32 位或64 位）。
- **I/O 设备**  I/O 设备是系统与外界的桥梁。每个 I/O设备都通过一个**控制器/适配器**与 I/O 总线相连以传递信息。
- **主存**  主存是一个临时存储设备，在处理器执行程序时，用来存放程序和程序处理的数据。
  - 物理上，主存是由一组**动态随机存取存储器（DRAM）**组成的。
  - 逻辑上，存储器是一个线性的字节数组，每个字节都有其唯一的地址。
- **处理器**  **中央处理单元（CPU）**，简称处理器，是解释执行存储在主存中指令的引擎。处理器的核心是一个大小为一个字的存储设备（或寄存器），称为**程序计数器（PC）**。在任何时刻 PC 都指向主存中的某条机器语言指令（即含该指令的地址）。在系统运行过程中，处理器一直在不断执行 PC 指向的指令，再更新 PC 使其指向下一条指令。执行指令围绕着主存、**寄存器文件**和**算术/逻辑单元（ALU）**进行。寄存器文件由一些单个字长的寄存器组成，是一个小的存储设备；ALU计算新的数据和地址值。下面是一些 CPU 的可能操作：
  - 加载：从主存复制一个字节或一个字到寄存器，以覆盖寄存器原来的内容。
  - 存储：从寄存器复制一个字节或者一个字到主存的某个位置，以覆盖这个位置上原来的内容。
  - 操作：将两个寄存器的内容复制到 ALU，ALU 对这两个字做算术运算，并将结果存放到一个寄存器中，以覆盖该寄存器中原来的内容。
  - 跳转：从指令本身中抽取一个字，并将这个字复制到程序计数器（PC）中，以覆盖原来的值。

#### 1.4.2 运行 hello 程序

